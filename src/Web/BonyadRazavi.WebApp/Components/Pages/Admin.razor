@page "/admin"
@page "/manage-users"
@using BonyadRazavi.WebApp.Components.Shared
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject UserSession UserSession
@inject NavigationManager Navigation
@inject AuthApiClient AuthApiClient
@inject UsersApiClient UsersApiClient

<PageTitle>مدیریت کاربران</PageTitle>

@if (!UserSession.IsAuthenticated || UserSession.Current is null)
{
    <section class="dashboard-state">
        <h1>جلسه کاربری فعال نیست</h1>
        <p>برای مشاهده پنل ادمین ابتدا وارد سامانه شوید.</p>
        <button class="dashboard-action" @onclick="GoToLogin">بازگشت به صفحه ورود</button>
    </section>
}
else if (!IsAdmin)
{
    <section class="dashboard-state">
        <h1>عدم دسترسی</h1>
        <p>شما مجوز لازم برای مشاهده پنل مدیریت کاربران را ندارید.</p>
        <button class="dashboard-action" @onclick="GoToDashboard">
            <img class="icon-dashboard" src="Images/dashboard/dashboard.png" />
            <span>داشبورد</span>
        </button>
    </section>
}
else
{
    <section class="portal-dashboard">
        <div class="dashboard-frame">
            <DashboardSidebar />

            <main class="dashboard-main">
                <header class="header-dashboard">
                    <div class="user-strip">
                        <div title="@UserSession.Current.UserName">
                            <img class="user-avatar" src="Images/dashboard/user.png" />
                        </div>
                        <p>@UserSession.Current.DisplayName</p>
                    </div>

                    <div class="btns-header">
                        <button class="btn-dashboard" @onclick="GoToDashboard">
                            <img class="icon-dashboard" src="Images/dashboard/dashboard.png" />
                            <span>داشبورد</span>
                        </button>
                        <div class="today-strip">پنل مدیریت کاربران</div>
                    </div>
                </header>

                <h1 class="welcome-title">مدیریت کاربران</h1>

                <div class="service-grid" style="grid-template-columns: 1fr;">
                    <div class="service-card admin-card">
                        <div class="admin-toolbar-header">
                            <h3>لیست کاربران</h3>
                            <div class="admin-toolbar-actions">
                                <button class="dashboard-action"
                                        @onclick="OpenCreateUserDialog"
                                        disabled="@_isLoading">
                                    افزودن کاربر
                                </button>
                                <button class="dashboard-action"
                                        @onclick="LoadUsersAsync"
                                        disabled="@_isLoading">
                                    @(_isLoading ? "در حال بارگذاری..." : "به‌روزرسانی")
                                </button>
                            </div>
                        </div>

                        <div class="admin-search-row">
                            <input @bind="_searchTerm"
                                   @bind:event="oninput"
                                   placeholder="جستجو بر اساس نام کاربری یا نام نمایشی"
                                   class="admin-search-input" />
                            <button class="dashboard-action" @onclick="ApplySearchAsync" disabled="@_isLoading">جستجو</button>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(_errorMessage))
                        {
                            <div class="admin-error">
                                @_errorMessage
                            </div>
                        }

                        <div>
                            <table class="users-table">
                                <thead>
                                    <tr style="background:#edf1ff;">
                                        <th>نام کاربری</th>
                                        <th>نام نمایشی</th>
                                        <th>نقش‌ها</th>
                                        <th>شرکت</th>
                                        <th>وضعیت</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (_users.Count == 0 && !_isLoading)
                                    {
                                        <tr>
                                            <td colspan="6" style="padding:1rem; text-align:center; border:1px solid #d7def6;">
                                                کاربری برای نمایش وجود ندارد.
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var user in _users)
                                        {
                                            <tr>
                                                <td style="padding:0.65rem; border:1px solid #d7def6;">@user.UserName</td>
                                                <td style="padding:0.65rem; border:1px solid #d7def6;">@user.DisplayName</td>
                                                <td style="padding:0.65rem; border:1px solid #d7def6;">@(user.Roles.Count > 0 ? string.Join("، ", user.Roles) : "-")</td>
                                                <td style="padding:0.65rem; border:1px solid #d7def6;">@(user.CompanyName ?? "-")</td>
                                                <td style="padding:0.65rem; border:1px solid #d7def6;">
                                                    @(user.IsActive ? "فعال" : "غیرفعال")
                                                </td>
                                                <td style="padding:0.65rem; border:1px solid #d7def6;">
                                                    <button class="dashboard-action admin-row-action"
                                                            @onclick="() => OpenEditUserDialog(user)"
                                                            disabled="@_isLoading">
                                                        اصلاح
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem; gap:1rem; flex-wrap:wrap;">
                            <div style="color:#102a5a;">
                                مجموع کاربران: @_totalCount
                            </div>
                            <div style="display:flex; align-items:center; gap:0.6rem;">
                                <button class="dashboard-action"
                                        style="min-width:120px;"
                                        @onclick="GoToPreviousPageAsync"
                                        disabled="@(!CanGoToPreviousPage || _isLoading)">
                                    صفحه قبل
                                </button>
                                <span style="color:#102a5a;">صفحه @_currentPage</span>
                                <button class="dashboard-action"
                                        style="min-width:120px;"
                                        @onclick="GoToNextPageAsync"
                                        disabled="@(!CanGoToNextPage || _isLoading)">
                                    صفحه بعد
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </section>
}

@if (_isEditorOpen)
{
    <div class="admin-modal-backdrop">
        <div class="admin-modal">
            <div class="admin-modal-header">
                <h3>@UserEditorTitle</h3>
                <button class="admin-modal-close" @onclick="CloseUserDialog" disabled="@_isSavingUser" title="بستن">
                    ×
                </button>
            </div>

            @if (!string.IsNullOrWhiteSpace(_userEditorError))
            {
                <div class="admin-error">
                    @_userEditorError
                </div>
            }

            <div class="admin-form-grid">
                <div>
                    <label>نام کاربری</label>
                    <input @bind="_editorUserName"
                           disabled="@IsEditMode"
                           placeholder="مثال: user01" />
                </div>
                <div>
                    <label>نام نمایشی</label>
                    <input @bind="_editorDisplayName"
                           placeholder="نام کامل کاربر" />
                </div>
                <div>
                    <label>نام شرکت</label>
                    <div class="admin-company-picker">
                        <input value="@SelectedCompanyName" readonly />
                        <button type="button"
                                class="dashboard-action admin-picker-toggle"
                                @onclick="ToggleCompanyPickerAsync"
                                disabled="@(_isSavingUser || _isLoadingCompanyDirectory)">
                            @(_isCompanyPickerOpen ? "بستن لیست" : "انتخاب شرکت")
                        </button>
                    </div>
                    @if (_isCompanyPickerOpen)
                    {
                        <div class="admin-company-list-panel">
                            <input @bind="_companySearchTerm"
                                   @bind:event="oninput"
                                   class="admin-company-search"
                                   placeholder="جستجو نام شرکت یا کد شرکت" />
                            <div class="admin-company-list">
                                @if (FilteredCompanies.Count == 0)
                                {
                                    <div class="admin-company-empty">شرکتی برای نمایش یافت نشد.</div>
                                }
                                else
                                {
                                    @foreach (var company in FilteredCompanies)
                                    {
                                        <button type="button"
                                                class="admin-company-item @(IsSelectedCompany(company) ? "is-selected" : string.Empty)"
                                                @onclick="@(() => SelectCompany(company))">
                                            @GetCompanyLabel(company)
                                        </button>
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="admin-form-span-2">
                    <label>
                        @if (IsEditMode)
                        {
                            <span>رمز عبور جدید (اختیاری)</span>
                        }
                        else
                        {
                            <span>رمز عبور اولیه</span>
                        }
                    </label>
                    <input @bind="_editorPassword"
                           type="password"
                           autocomplete="new-password"
                           placeholder="حداقل 8 کاراکتر" />
                </div>
            </div>

            <div class="admin-role-box">
                <p>نقش‌ها</p>
                <div class="admin-role-items">
                    @foreach (var role in EditableRoles)
                    {
                        <label>
                            <input type="checkbox"
                                   checked="@IsRoleSelected(role)"
                                   @onchange="args => ToggleRole(role, args)" />
                            <span>@role</span>
                        </label>
                    }
                </div>
            </div>

            <div class="admin-toggle-row">
                <label>
                    <input type="checkbox" @bind="_editorIsActive" />
                    <span>کاربر فعال باشد</span>
                </label>
                <label>
                    <input type="checkbox" @bind="_editorIsCompanyActive" />
                    <span>شرکت فعال باشد</span>
                </label>
            </div>

            <div class="admin-modal-actions">
                <button class="dashboard-action" @onclick="SaveUserAsync" disabled="@_isSavingUser">
                    @SaveButtonTitle
                </button>
                <button class="dashboard-action dashboard-action-secondary"
                        @onclick="CloseUserDialog"
                        disabled="@_isSavingUser">
                    انصراف
                </button>
            </div>
        </div>
    </div>
}


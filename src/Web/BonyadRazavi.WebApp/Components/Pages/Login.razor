@page "/"
@page "/login"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject AuthApiClient AuthApiClient
@inject UserSession UserSession
@inject NavigationManager Navigation

<PageTitle>ورود به پرتال</PageTitle>

<div class="login-layout">
    <section class="brand-panel">
        <div class="brand-bg-orb"></div>
        <div class="brand-content">
           <img  src="./Images/logo-RASF1.png" width="300" alt="logo RASF"/>
            <p class="brand-title">بنیاد علوم کاربردی رازی</p>
            <p class="brand-subtitle">سامانه یکپارچه خدمات و مدیریت فرآیندها</p>
        </div>
    </section>

    <section class="form-panel">
        <div class="login-card">
            <h1 class="text-center" style="margin-bottom: 30%;">پرتال بنیاد علوم کاربردی رازی</h1>

            <EditForm Model="_model" OnValidSubmit="OnSubmitAsync">
                <DataAnnotationsValidator />

                <div class="field-block">
                    <InputText Style="background-color: #F0F1FD;" class="portal-input p-3 w-100 rounded-3 border-0" @bind-Value="_model.UserName" placeholder="نام کاربری" />
                    <ValidationMessage For="@(() => _model.UserName)" />
                </div>

                <div class="field-block">
                    <InputText Style="background-color: #F0F1FD;" class="portal-input p-3 w-100 rounded-3 border-0" type="password" @bind-Value="_model.Password" placeholder="کلمه عبور" />
                    <ValidationMessage For="@(() => _model.Password)" />
                </div>

                <button class="ghost-link" type="button">فراموشی کلمه عبور</button>

                <button class="login-button" type="submit" disabled="@_isSubmitting">
                    @(_isSubmitting ? "در حال بررسی..." : "ورود به پنل کاربری")
                </button>
            </EditForm>

            @if (!string.IsNullOrWhiteSpace(_errorMessage))
            {
                <p class="login-error">@_errorMessage</p>
            }

            @* <p class="hint-text">
                کاربر آزمایشی: <span>admin</span>
                <br />
                رمز عبور: <span>Razavi@1404</span>
            </p> *@
        </div>
    </section>
</div>

@code {
    private readonly LoginRequest _model = new();
    private bool _isSubmitting;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        if (UserSession.IsAuthenticated)
        {
            Navigation.NavigateTo("/dashboard");
        }
    }

    private async Task OnSubmitAsync()
    {
        _errorMessage = null;
        _isSubmitting = true;

        try
        {
            var loginRequest = new LoginRequest
            {
                UserName = _model.UserName.Trim(),
                Password = _model.Password
            };

            var loginResult = await AuthApiClient.LoginAsync(loginRequest);
            if (loginResult.IsSuccess && loginResult.Payload is not null)
            {
                UserSession.SignIn(loginResult.Payload);
                Navigation.NavigateTo("/dashboard");
                return;
            }

            _errorMessage = loginResult.ErrorMessage ?? "ورود ناموفق بود.";
        }
        catch
        {
            _errorMessage = "ارتباط با سرویس برقرار نشد. لطفا سرویس Gateway را بررسی کنید.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}

